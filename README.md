# Инструкция по настройке и тестированию Keycloak с Token Exchange

## Предварительные требования

- Установленный Docker и Docker Compose
- PowerShell
- Файл `realm-export.json` с настройками realm

## Шаги

### 1. Запуск Keycloak в Docker

1. Откройте терминал и перейдите в директорию с файлом `docker-compose.yml`.
2. Выполните команду:
   ```
   docker-compose up -d
   ```
3. Дождитесь полного запуска Keycloak (это может занять несколько минут).

### 2. Импорт realm

1. Откройте административную консоль Keycloak по адресу `http://localhost:8080`.
2. Войдите, используя учетные данные администратора (admin/admin_password).
3. Нажмите "Add realm" и импортируйте файл `realm-export.json`.

### 3. Создание тестового пользователя

Выполните скрипт `create-test-user.ps1`:

`powershell .\create-test-user.ps1`

Это создаст пользователя `test_user` с атрибутом `current-role-id` равным "1".

### 4. Проверка работы Token Exchange

Запустите скрипт `exchange-token.ps1`:

`powershell .\exchange-token.ps1`

Убедитесь, что Token Exchange работает корректно и в полученном токене claim `rid` равен 1.

### 5. Изменение атрибута пользователя

Выполните скрипт `update-user-attribute.ps1` для изменения значения атрибута `current-role-id`:

`powershell .\update-user-attribute.ps1`

Это изменит значение атрибута `current-role-id` на значение, отличное от 1 (по умолчанию на 3).

### 6. Повторная проверка Token Exchange

Снова запустите скрипт `exchange-token.ps1`:

`powershell .\exchange-token.ps1`

Убедитесь, что в новом токене claim `rid` содержит обновленное значение атрибута `current-role-id`.

## Примечания

- Убедитесь, что все скрипты PowerShell находятся в одной директории.
- При необходимости измените параметры в скриптах (например, URL Keycloak, имена пользователей и пароли) в соответствии с вашей конфигурацией.
- Если возникают проблемы с кодировкой, убедитесь, что все файлы сохранены в кодировке UTF-8 без BOM.

Этот README файл предоставляет пошаговую инструкцию для выполнения всех указанных вами действий, включая запуск Keycloak, создание пользователя, проверку Token Exchange и изменение атрибутов пользователя.